# name: test/sql/graph_outlook_integration.test
# description: Integration tests for Microsoft Graph Outlook
# group: [erpl_web]
# note: Outlook functions require delegated authentication
#       Use authorization_code provider or set ERPL_MS_DELEGATED_ACCESS_TOKEN

require erpl_web

require-env ERPL_MS_TENANT_ID

require-env ERPL_MS_CLIENT_ID

require-env ERPL_MS_DELEGATED_ACCESS_TOKEN

require-env ERPL_MS_DELEGATED_EXPIRES_AT

# Create secret with delegated (user) credentials
statement ok
CREATE SECRET ms_graph_outlook_test (
    TYPE microsoft_graph,
    PROVIDER config,
    tenant_id '${ERPL_MS_TENANT_ID}',
    client_id '${ERPL_MS_CLIENT_ID}',
    access_token '${ERPL_MS_DELEGATED_ACCESS_TOKEN}',
    expires_at '${ERPL_MS_DELEGATED_EXPIRES_AT}'
);

# Test: graph_calendar_events returns data (may be empty)
query I
SELECT COUNT(*) >= 0 FROM graph_calendar_events();
----
true

# Test: graph_calendar_events has expected columns
query I
SELECT COUNT(*) FROM (
    SELECT column_name FROM (DESCRIBE SELECT * FROM graph_calendar_events())
    WHERE column_name IN ('id', 'subject', 'body_preview', 'start_time', 'end_time', 'location', 'organizer_name', 'is_all_day', 'is_cancelled', 'web_link')
);
----
10

# Test: graph_contacts returns data (may be empty)
query I
SELECT COUNT(*) >= 0 FROM graph_contacts();
----
true

# Test: graph_contacts has expected columns
query I
SELECT COUNT(*) FROM (
    SELECT column_name FROM (DESCRIBE SELECT * FROM graph_contacts())
    WHERE column_name IN ('id', 'display_name', 'given_name', 'surname', 'email', 'mobile_phone', 'business_phone', 'company_name', 'job_title')
);
----
9

# Test: graph_messages returns data (may be empty)
query I
SELECT COUNT(*) >= 0 FROM graph_messages();
----
true

# Test: graph_messages has expected columns
query I
SELECT COUNT(*) FROM (
    SELECT column_name FROM (DESCRIBE SELECT * FROM graph_messages())
    WHERE column_name IN ('id', 'subject', 'body_preview', 'from_name', 'from_email', 'received_at', 'has_attachments', 'is_read', 'importance', 'web_link')
);
----
10

# Cleanup
statement ok
DROP SECRET ms_graph_outlook_test;
