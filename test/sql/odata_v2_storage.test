# name: test/sql/odata_v2_storage.test
# description: test erpl_odata extension for OData v2 service (Northwind), including attach functionality
# group: [erpl_odata]

# Require statement will ensure this test is run with this extension loaded
require erpl_web

statement ok
SET autoinstall_known_extensions=1;

statement ok
SET autoload_known_extensions=1;

statement ok
SET erpl_trace_enabled=false;

# ============================================================================
# OData v2 Service Storage Testing (Northwind)
# ============================================================================

# Test ATTACH command works
statement ok
ATTACH 'https://services.odata.org/V2/Northwind/Northwind.svc/' AS northwind (TYPE odata)

# Test that database is attached
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'northwind';
----
1

# Test SHOW TABLES works and returns expected number of tables
query I
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'main' AND table_catalog = 'northwind';
----
26

# Test basic SELECT queries work
query T
SELECT CategoryName FROM northwind.Categories WHERE CategoryID = 1;
----
Beverages

# Test SELECT with multiple columns
query II
SELECT CategoryID, CategoryName FROM northwind.Categories WHERE CategoryID <= 2 ORDER BY CategoryID;
----
1	Beverages
2	Condiments

# Test querying customer data
query T
SELECT CustomerID FROM northwind.Customers WHERE CustomerID = 'ALFKI';
----
ALFKI

# Test querying product data  
query T
SELECT ProductName FROM northwind.Products WHERE ProductID = 1;
----
Chai

# Test COUNT works on Categories (smaller table)
query I
SELECT COUNT(*) FROM northwind.Categories;
----
8

# ============================================================================
# Multi-database testing
# ============================================================================

# Attach second database
statement ok
ATTACH 'https://services.odata.org/TripPinRESTierService/' AS trippin (TYPE odata)

# Test both databases work together
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name IN ('northwind', 'trippin');
----
2

# Test cross-database table listing
query I
SELECT COUNT(*) FROM information_schema.tables WHERE table_catalog IN ('northwind', 'trippin');
----
29

# ============================================================================
# Cleanup
# ============================================================================

statement ok
SELECT 'OData v2 storage tests completed...' as status;
