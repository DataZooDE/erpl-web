# name: test/sql/odata_v4_storage.test
# description: test erpl_odata extension for OData v4 service (TripPin), including attach functionality
# group: [erpl_odata]

# Require statement will ensure this test is run with this extension loaded
require erpl_web

statement ok
SET autoinstall_known_extensions=1;

statement ok
SET autoload_known_extensions=1;

statement ok
SET erpl_trace_enabled=false;

# ============================================================================
# OData v4 Service Storage Testing (TripPin)
# ============================================================================

# Test ATTACH command works
statement ok
ATTACH 'https://services.odata.org/TripPinRESTierService/' AS trippin (TYPE odata)

# Test that database is attached
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'trippin';
----
1

# Test SHOW TABLES works and returns expected number of tables
query I
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'main' AND table_catalog = 'trippin';
----
3

# Test basic SELECT queries work on Airlines
query T
SELECT AirlineCode FROM trippin.Airlines WHERE AirlineCode = 'AA';
----
AA

# Test SELECT with multiple columns
query TT
SELECT AirlineCode, Name FROM trippin.Airlines WHERE AirlineCode = 'AA';
----
AA	American Airlines

# Test querying person data (get first person)
query T
SELECT UserName FROM trippin.People LIMIT 1;
----
russellwhyte

# Test querying with FirstName and LastName (get first person)
query T
SELECT FirstName FROM trippin.People LIMIT 1;
----
Russell

# Test airport data (get first airport)
query T
SELECT Name FROM trippin.Airports LIMIT 1;
----
San Francisco International Airport

# ============================================================================
# Multi-database testing with V2 service
# ============================================================================

# Attach V2 database
statement ok
ATTACH 'https://services.odata.org/V2/Northwind/Northwind.svc/' AS northwind (TYPE odata)

# Test both databases work together
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name IN ('northwind', 'trippin');
----
2

# Test cross-database queries
query T
SELECT CategoryName FROM northwind.Categories WHERE CategoryID = 1;
----
Beverages

query T
SELECT AirlineCode FROM trippin.Airlines WHERE AirlineCode = 'AA';
----
AA

# ============================================================================
# Cleanup
# ============================================================================

statement ok
SELECT 'OData v4 storage tests completed...' as status;
