# name: test/sql/microsoft_entra.test
# description: Test Microsoft Entra ID authentication secret management
# group: [microsoft_entra]

require erpl_web

# Test 1: Create a Microsoft Entra secret with client_credentials provider
statement ok
CREATE SECRET test_entra_client_creds (
    TYPE microsoft_entra,
    tenant_id 'test-tenant-id-12345',
    client_id 'test-client-id-67890',
    client_secret 'test-client-secret-abcde',
    scope 'https://graph.microsoft.com/.default'
);

# Verify the secret was created
query III
SELECT name, type, provider FROM duckdb_secrets() WHERE name = 'test_entra_client_creds';
----
test_entra_client_creds	microsoft_entra	client_credentials

# Test 2: Create a Microsoft Entra secret with config provider and explicit token
statement ok
CREATE SECRET test_entra_config (
    TYPE microsoft_entra,
    PROVIDER config,
    tenant_id 'config-tenant-id',
    client_id 'config-client-id',
    access_token 'pre-acquired-access-token'
);

# Verify the config secret was created
query III
SELECT name, type, provider FROM duckdb_secrets() WHERE name = 'test_entra_config';
----
test_entra_config	microsoft_entra	config

# Test 3: Create a Microsoft Entra secret with default scope (should default to Graph API)
statement ok
CREATE SECRET test_entra_default_scope (
    TYPE microsoft_entra,
    tenant_id 'default-scope-tenant',
    client_id 'default-scope-client',
    client_secret 'default-scope-secret'
);

query III
SELECT name, type, provider FROM duckdb_secrets() WHERE name = 'test_entra_default_scope';
----
test_entra_default_scope	microsoft_entra	client_credentials

# Test 4: Verify required parameters - missing tenant_id should fail
statement error
CREATE SECRET test_entra_no_tenant (
    TYPE microsoft_entra,
    client_id 'some-client-id',
    client_secret 'some-client-secret'
);
----
'tenant_id' is required

# Test 5: Verify required parameters - missing client_id should fail
statement error
CREATE SECRET test_entra_no_client_id (
    TYPE microsoft_entra,
    tenant_id 'some-tenant-id',
    client_secret 'some-client-secret'
);
----
'client_id' is required

# Test 6: Verify required parameters - missing client_secret should fail
statement error
CREATE SECRET test_entra_no_client_secret (
    TYPE microsoft_entra,
    tenant_id 'some-tenant-id',
    client_id 'some-client-id'
);
----
'client_secret' is required

# Test 7: Verify secret redaction (sensitive fields should be redacted)
# Note: We can't easily verify redaction in SQLLogicTest, but we ensure the secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'microsoft_entra';
----
3

# ============================================================================
# Additional Integration Tests for Token Flow
# ============================================================================

# Test 8: Config provider with pre-acquired token and expiration timestamp
# This tests the cached token retrieval path in MicrosoftEntraTokenManager::GetToken()
statement ok
CREATE SECRET test_entra_cached_token (
    TYPE microsoft_entra,
    PROVIDER config,
    tenant_id 'cached-token-tenant',
    client_id 'cached-token-client',
    access_token 'my-cached-access-token-value'
);

query III
SELECT name, type, provider FROM duckdb_secrets() WHERE name = 'test_entra_cached_token';
----
test_entra_cached_token	microsoft_entra	config

# Test 9: Multiple secrets with different scopes for different services
statement ok
CREATE SECRET entra_for_graph (
    TYPE microsoft_entra,
    tenant_id 'multi-scope-tenant',
    client_id 'multi-scope-client',
    client_secret 'multi-scope-secret',
    scope 'https://graph.microsoft.com/.default'
);

statement ok
CREATE SECRET entra_for_bc (
    TYPE microsoft_entra,
    tenant_id 'multi-scope-tenant',
    client_id 'multi-scope-client',
    client_secret 'multi-scope-secret',
    scope 'https://api.businesscentral.dynamics.com/.default'
);

statement ok
CREATE SECRET entra_for_dynamics (
    TYPE microsoft_entra,
    tenant_id 'multi-scope-tenant',
    client_id 'multi-scope-client',
    client_secret 'multi-scope-secret',
    scope 'https://org.crm.dynamics.com/.default'
);

# Verify all secrets were created (3 from tests 1-3, 1 cached token, 3 multi-scope = 7)
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'microsoft_entra';
----
7

# Test 10: Secret replacement (OR REPLACE)
statement ok
CREATE OR REPLACE SECRET test_entra_client_creds (
    TYPE microsoft_entra,
    tenant_id 'replaced-tenant-id',
    client_id 'replaced-client-id',
    client_secret 'replaced-client-secret',
    scope 'https://graph.microsoft.com/.default'
);

query III
SELECT name, type, provider FROM duckdb_secrets() WHERE name = 'test_entra_client_creds';
----
test_entra_client_creds	microsoft_entra	client_credentials

# Test 11: Config provider is more permissive (no required fields)
# This allows pre-configured tokens without full credentials
statement ok
CREATE SECRET test_entra_minimal_config (
    TYPE microsoft_entra,
    PROVIDER config,
    access_token 'standalone-token-value'
);

query III
SELECT name, type, provider FROM duckdb_secrets() WHERE name = 'test_entra_minimal_config';
----
test_entra_minimal_config	microsoft_entra	config

# ============================================================================
# Cleanup
# ============================================================================

statement ok
DROP SECRET IF EXISTS test_entra_client_creds;

statement ok
DROP SECRET IF EXISTS test_entra_config;

statement ok
DROP SECRET IF EXISTS test_entra_default_scope;

statement ok
DROP SECRET IF EXISTS test_entra_cached_token;

statement ok
DROP SECRET IF EXISTS entra_for_graph;

statement ok
DROP SECRET IF EXISTS entra_for_bc;

statement ok
DROP SECRET IF EXISTS entra_for_dynamics;

statement ok
DROP SECRET IF EXISTS test_entra_minimal_config;

# Verify cleanup
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'microsoft_entra';
----
0
